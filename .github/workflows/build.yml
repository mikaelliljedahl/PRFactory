name: Build and Test

on:
  push:
    branches: [ main, claude/** ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '10.0.x'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  build:
    name: Build & Test
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Display .NET version
      run: dotnet --version

    - name: Restore dependencies
      run: dotnet restore PRFactory.sln

    - name: Build solution
      run: dotnet build PRFactory.sln --configuration Release --no-restore

    - name: Run tests
      run: dotnet test PRFactory.sln --configuration Release --no-build --verbosity normal --logger "trx;LogFileName=test-results.trx"

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: '**/TestResults/*.trx'

    - name: Build summary
      if: always()
      run: |
        echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "âœ… .NET Version: $(dotnet --version)" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Solution: PRFactory.sln" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Configuration: Release" >> $GITHUB_STEP_SUMMARY

  code-analysis:
    name: Code Analysis
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore dependencies
      run: dotnet restore PRFactory.sln

    - name: Build for analysis
      run: dotnet build PRFactory.sln --configuration Debug --no-restore

    - name: Count lines of code
      run: |
        echo "## Code Statistics" >> $GITHUB_STEP_SUMMARY
        echo "### C# Files" >> $GITHUB_STEP_SUMMARY
        find src -name "*.cs" -type f | wc -l | xargs echo "ðŸ“„ Total Files:" >> $GITHUB_STEP_SUMMARY
        find src -name "*.cs" -type f -exec cat {} \; | wc -l | xargs echo "ðŸ“ Total Lines:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Project Breakdown" >> $GITHUB_STEP_SUMMARY
        for dir in src/PRFactory.*/; do
          count=$(find "$dir" -name "*.cs" -type f | wc -l)
          lines=$(find "$dir" -name "*.cs" -type f -exec cat {} \; | wc -l)
          echo "- $(basename $dir): $count files, $lines lines" >> $GITHUB_STEP_SUMMARY
        done

  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build API Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: src/PRFactory.Api/Dockerfile
        push: false
        tags: prfactory-api:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Docker build summary
      run: |
        echo "## Docker Build" >> $GITHUB_STEP_SUMMARY
        echo "âœ… API Image: prfactory-api:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
