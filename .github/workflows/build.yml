name: Build and Test

on:
  push:
    branches: [ main, claude/** ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '10.0.x'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  build:
    name: Build & Test
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Display .NET version
      run: dotnet --version

    - name: Restore dependencies
      run: dotnet restore PRFactory.sln

    - name: Build solution
      run: dotnet build PRFactory.sln --configuration Release --no-restore

    - name: Check for build warnings
      if: github.event_name == 'pull_request'
      run: |
        dotnet build PRFactory.sln --configuration Release --no-restore > build.log 2>&1 || true
        if grep -i "warning" build.log; then
          echo "âš ï¸ Build warnings detected" >> $GITHUB_STEP_SUMMARY
          grep -i "warning" build.log >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… No build warnings" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Run tests
      run: dotnet test PRFactory.sln --configuration Release --no-build --verbosity normal --logger "trx;LogFileName=test-results.trx"

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: '**/TestResults/*.trx'

    - name: Build summary
      if: always()
      run: |
        echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "âœ… .NET Version: $(dotnet --version)" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Solution: PRFactory.sln" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Configuration: Release" >> $GITHUB_STEP_SUMMARY

  code-analysis:
    name: Code Analysis
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore dependencies
      run: dotnet restore PRFactory.sln

    - name: Build for analysis
      run: dotnet build PRFactory.sln --configuration Debug --no-restore

    - name: Count lines of code
      run: |
        echo "## Code Statistics" >> $GITHUB_STEP_SUMMARY
        echo "### C# Files" >> $GITHUB_STEP_SUMMARY
        find src -name "*.cs" -type f | wc -l | xargs echo "ðŸ“„ Total Files:" >> $GITHUB_STEP_SUMMARY
        find src -name "*.cs" -type f -exec cat {} \; | wc -l | xargs echo "ðŸ“ Total Lines:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Project Breakdown" >> $GITHUB_STEP_SUMMARY
        for dir in src/PRFactory.*/; do
          count=$(find "$dir" -name "*.cs" -type f | wc -l)
          lines=$(find "$dir" -name "*.cs" -type f -exec cat {} \; | wc -l)
          echo "- $(basename $dir): $count files, $lines lines" >> $GITHUB_STEP_SUMMARY
        done

    - name: Validate project references
      if: github.event_name == 'pull_request'
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Project Dependency Validation" >> $GITHUB_STEP_SUMMARY
        echo "Checking for circular dependencies..." >> $GITHUB_STEP_SUMMARY
        dotnet list PRFactory.sln reference || echo "âœ… No circular dependencies found" >> $GITHUB_STEP_SUMMARY
