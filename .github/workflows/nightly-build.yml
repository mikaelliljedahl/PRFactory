name: Nightly Build

on:
  schedule:
    # Run at 2 AM UTC every day
    - cron: '0 2 * * *'
  workflow_dispatch:

env:
  DOTNET_VERSION: '10.0.x'

jobs:
  full-build:
    name: Full Nightly Build
    runs-on: ubuntu-latest

    strategy:
      matrix:
        configuration: [Debug, Release]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Clean workspace
      run: dotnet clean PRFactory.sln

    - name: Restore dependencies
      run: dotnet restore PRFactory.sln --verbosity detailed

    - name: Build all projects
      run: |
        dotnet build src/PRFactory.Domain/PRFactory.Domain.csproj --configuration ${{ matrix.configuration }} --no-restore
        dotnet build src/PRFactory.Infrastructure/PRFactory.Infrastructure.csproj --configuration ${{ matrix.configuration }} --no-restore
        dotnet build src/PRFactory.Api/PRFactory.Api.csproj --configuration ${{ matrix.configuration }} --no-restore
        dotnet build src/PRFactory.Worker/PRFactory.Worker.csproj --configuration ${{ matrix.configuration }} --no-restore
        dotnet build tests/PRFactory.Tests/PRFactory.Tests.csproj --configuration ${{ matrix.configuration }} --no-restore

    - name: Run all tests
      run: dotnet test PRFactory.sln --configuration ${{ matrix.configuration }} --no-build --verbosity detailed

    - name: Generate build report
      if: always()
      run: |
        echo "## Nightly Build Report (${{ matrix.configuration }})" >> $GITHUB_STEP_SUMMARY
        echo "**Date:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "**Configuration:** ${{ matrix.configuration }}" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Projects Built" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ PRFactory.Domain" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ PRFactory.Infrastructure" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ PRFactory.Api" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ PRFactory.Worker" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ PRFactory.Tests" >> $GITHUB_STEP_SUMMARY

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: full-build

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Run integration tests
      env:
        ASPNETCORE_ENVIRONMENT: Development
        ConnectionStrings__DefaultConnection: Data Source=test.db
      run: |
        dotnet restore PRFactory.sln
        dotnet build PRFactory.sln --configuration Release --no-restore
        dotnet test tests/PRFactory.Tests/PRFactory.Tests.csproj --filter "Category=Integration" --configuration Release --no-build || true

    - name: Cleanup test database
      if: always()
      run: rm -f test.db
