╔═══════════════════════════════════════════════════════════════════════════╗
║           CodeReviewGraph Integration - Transition Flow Diagram           ║
╚═══════════════════════════════════════════════════════════════════════════╝

┌─────────────────────────────────────────────────────────────────────────────┐
│                         Workflow Orchestrator                                │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                                     │ TriggerTicketMessage
                                     ▼
                          ┌────────────────────┐
                          │  RefinementGraph   │
                          │  (Ticket Analysis) │
                          └──────────┬─────────┘
                                     │
                                     │ RefinementCompleteEvent
                                     ▼
                          ┌────────────────────┐
                          │   PlanningGraph    │
                          │  (Create Plan)     │
                          └──────────┬─────────┘
                                     │
                                     │ PlanApprovedEvent
                                     ▼
                          ┌────────────────────┐
                          │ ImplementationGraph│
                          │  (Write Code)      │
                          └──────────┬─────────┘
                                     │
                                     │ PRCreatedMessage
                                     ▼
                    ┌────────────────────────────────┐
                    │ Check: EnableAutoCodeReview?   │
                    └────────┬───────────────┬───────┘
                             │ YES           │ NO
                             │               │
                             ▼               ▼
              ┌────────────────────┐   ┌─────────────────┐
              │  CodeReviewGraph   │   │ Complete        │
              │  (Review PR)       │   │ Workflow        │
              └──────────┬─────────┘   │ ✓ Success       │
                         │             └─────────────────┘
                         │ CodeReviewCompleteMessage
                         ▼
         ┌───────────────────────────────────┐
         │ Check: HasCriticalIssues?         │
         └────────┬──────────────────┬───────┘
                  │ YES              │ NO
                  │                  │
                  ▼                  ▼
    ┌─────────────────────┐   ┌──────────────────────┐
    │ Check: Retry Count  │   │ Check: Auto Approve? │
    │ < MaxIterations?    │   └──────────┬───────────┘
    └────┬───────────┬────┘              │
         │ YES       │ NO                 ▼
         │           │           ┌──────────────────┐
         │           │           │ Post Approval    │
         │           │           │ Comment (if yes) │
         │           │           └────────┬─────────┘
         │           │                    │
         │           ▼                    ▼
         │   ┌─────────────────┐   ┌─────────────────┐
         │   │ Complete        │   │ Complete        │
         │   │ Workflow        │   │ Workflow        │
         │   │ ⚠️  Warnings    │   │ ✓ Success       │
         │   └─────────────────┘   └─────────────────┘
         │
         │ FixCodeIssuesMessage
         ▼
┌──────────────────────┐
│ ImplementationGraph  │ ◄─┐
│ (Fix Issues)         │   │
└──────────┬───────────┘   │
           │               │
           │ PRCreatedMessage   Loop back
           ▼               │
┌──────────────────────┐   │
│  CodeReviewGraph     │   │
│  (Re-review PR)      │ ──┘
└──────────────────────┘

═══════════════════════════════════════════════════════════════════════════════

Configuration Properties (TenantConfiguration):

┌─────────────────────────────────────────────────────────────────────────────┐
│ Property Name                    │ Type    │ Default │ Description           │
├──────────────────────────────────┼─────────┼─────────┼──────────────────────┤
│ EnableAutoCodeReview             │ bool    │ false   │ Trigger code review   │
│ CodeReviewLlmProviderId          │ Guid?   │ null    │ Provider for review   │
│ ImplementationLlmProviderId      │ Guid?   │ null    │ Provider for impl     │
│ PlanningLlmProviderId            │ Guid?   │ null    │ Provider for plan     │
│ AnalysisLlmProviderId            │ Guid?   │ null    │ Provider for analysis │
│ MaxCodeReviewIterations          │ int     │ 3       │ Max review loops      │
│ AutoApproveIfNoIssues            │ bool    │ false   │ Auto-post approval    │
│ RequireHumanApprovalAfterReview  │ bool    │ true    │ Future use            │
└─────────────────────────────────────────────────────────────────────────────┘

═══════════════════════════════════════════════════════════════════════════════

Example Scenarios:

Scenario 1: Code Review Disabled
  ImplementationGraph → PRCreatedMessage → Complete ✓

Scenario 2: Code Review Enabled, No Issues
  ImplementationGraph → PRCreatedMessage
    → CodeReviewGraph → No Issues
      → Post Approval (if AutoApproveIfNoIssues = true)
        → Complete ✓

Scenario 3: Code Review Enabled, Issues Found, Fixed in Loop
  ImplementationGraph → PRCreatedMessage
    → CodeReviewGraph → Issues Found (retry=1)
      → ImplementationGraph (fix) → PRCreatedMessage
        → CodeReviewGraph → No Issues
          → Complete ✓

Scenario 4: Code Review Enabled, Max Retries Reached
  ImplementationGraph → PRCreatedMessage
    → CodeReviewGraph → Issues Found (retry=1)
      → ImplementationGraph (fix) → PRCreatedMessage
        → CodeReviewGraph → Issues Found (retry=2)
          → ImplementationGraph (fix) → PRCreatedMessage
            → CodeReviewGraph → Issues Found (retry=3)
              → Max Retries Reached
                → Complete ⚠️ with warnings

═══════════════════════════════════════════════════════════════════════════════

Key Decision Points in Code:

1. WorkflowOrchestrator.HandleImplementationCompletionAsync()
   └─ Check: result.OutputMessage is PRCreatedMessage?
      └─ Check: tenantConfig.EnableAutoCodeReview == true?
         └─ Execute CodeReviewGraph

2. WorkflowOrchestrator.HandleCodeReviewCompletionAsync()
   └─ Check: reviewComplete.HasCriticalIssues?
      ├─ NO → Complete workflow (check AutoApproveIfNoIssues)
      └─ YES → Check retry count
         ├─ < MaxIterations → Loop to ImplementationGraph
         └─ >= MaxIterations → Complete with warnings

═══════════════════════════════════════════════════════════════════════════════
