@namespace PRFactory.Web.Components.Tickets
@using PRFactory.Web.Models
@using PRFactory.Web.UI.Help
@using PRFactory.Web.UI.Editors

<div class="row">
    <div class="col-lg-8 mb-3">
        <div class="card mb-3">
    <div class="card-header bg-primary text-white">
        <h4 class="mb-0">
            <i class="bi bi-file-earmark-text"></i> Implementation Plan Ready for Review
        </h4>
    </div>
    <div class="card-body">
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i>
            <strong>Plan Generated</strong> - An implementation plan has been created and is ready for your review.
        </div>

        @if (!string.IsNullOrEmpty(Ticket.PlanBranchName))
        {
            <div class="mb-3">
                <h5>Plan Details</h5>
                <dl class="row">
                    <dt class="col-sm-3">Branch:</dt>
                    <dd class="col-sm-9">
                        <code>@Ticket.PlanBranchName</code>
                    </dd>

                    @if (!string.IsNullOrEmpty(Ticket.PlanMarkdownPath))
                    {
                        <dt class="col-sm-3">Plan File:</dt>
                        <dd class="col-sm-9">
                            <code>@Ticket.PlanMarkdownPath</code>
                        </dd>
                    }
                </dl>

                <p class="text-muted">
                    <small>
                        <i class="bi bi-lightbulb"></i>
                        Check out the plan branch to review the implementation details in your repository.
                    </small>
                </p>
            </div>

            <div class="plan-actions-container">
                <h5 class="mb-3">Review Actions</h5>

                <!-- Help Section -->
                <div class="alert alert-light border mb-3">
                    <h6 class="mb-2"><i class="bi bi-info-circle me-2"></i>What do these actions do?</h6>
                    <ul class="mb-0 small">
                        <li><strong>Approve:</strong> The plan is good. Proceed to implementation (auto or manual based on your settings).</li>
                        <li><strong>Refine:</strong> The plan is mostly good but needs specific improvements. Provide instructions to adjust it while keeping its structure.</li>
                        <li><strong>Reject & Regenerate:</strong> The plan misses the mark entirely. Start over from scratch with your feedback.</li>
                    </ul>
                </div>

                @if (showRefineForm)
                {
                    <div class="refine-form-container">
                        <div class="alert alert-info mb-3">
                            <i class="bi bi-info-circle"></i>
                            <strong>Refine Plan:</strong> Provide specific instructions to improve the plan while keeping its overall structure.
                        </div>

                        <!-- Examples Section -->
                        <div class="mb-3">
                            <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="@(() => showExamples = !showExamples)">
                                <i class="bi bi-@(showExamples ? "chevron-down" : "chevron-right") me-1"></i>
                                @(showExamples ? "Hide" : "Show") Examples
                            </button>
                        </div>

                        @if (showExamples)
                        {
                            <div class="examples-box mb-3">
                                <h6 class="mb-2">Example Refinement Instructions:</h6>
                                <ul class="small mb-0">
                                    <li>"Add database migration steps to the implementation plan"</li>
                                    <li>"Use dependency injection instead of static classes for the service layer"</li>
                                    <li>"Include integration tests for the API endpoints"</li>
                                    <li>"Add error handling for network failures in the data sync logic"</li>
                                    <li>"Include TypeScript type definitions for the frontend models"</li>
                                    <li>"Add logging statements for debugging the workflow transitions"</li>
                                </ul>
                            </div>
                        }

                        <div class="mb-3">
                            <label for="refinementInstructions" class="form-label">
                                <strong>Refinement Instructions</strong> <span class="text-danger">*</span>
                            </label>
                            <MarkdownEditor @bind-Value="refinementInstructions"
                                            Height="400px"
                                            ShowToolbar="true"
                                            ShowPreview="true" />
                            @if (showRefineError)
                            {
                                <div class="invalid-feedback d-block">
                                    Please provide refinement instructions.
                                </div>
                            }
                        </div>

                        <div class="d-flex gap-2">
                            <button class="btn btn-primary" @onclick="ConfirmRefine" disabled="@isSubmitting">
                                @if (isSubmitting)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                }
                                <i class="bi bi-arrow-repeat me-2"></i> Refine Plan
                            </button>
                            <button class="btn btn-outline-secondary" @onclick="CancelRefine" disabled="@isSubmitting">
                                Cancel
                            </button>
                        </div>
                    </div>
                }
                else if (showRejectForm)
                {
                    <div class="reject-form-container">
                        <div class="alert alert-warning mb-3">
                            <i class="bi bi-exclamation-triangle"></i>
                            <strong>Reject & Regenerate:</strong> The plan will be completely regenerated from scratch based on your feedback.
                        </div>
                        <div class="mb-3">
                            <label for="rejectionReason" class="form-label">
                                <strong>Rejection Reason</strong> <span class="text-danger">*</span>
                            </label>
                            <MarkdownEditor @bind-Value="rejectionReason"
                                            Height="300px"
                                            ShowToolbar="true"
                                            ShowPreview="true" />
                            @if (showRejectError)
                            {
                                <div class="invalid-feedback d-block">
                                    Please provide a reason for rejecting the plan.
                                </div>
                            }
                        </div>

                        <div class="d-flex gap-2">
                            <button class="btn btn-danger" @onclick="ConfirmReject" disabled="@isSubmitting">
                                @if (isSubmitting)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                }
                                <i class="bi bi-x-circle me-2"></i> Reject & Regenerate
                            </button>
                            <button class="btn btn-outline-secondary" @onclick="CancelReject" disabled="@isSubmitting">
                                Cancel
                            </button>
                        </div>
                    </div>
                }
                else
                {
                    <div class="d-flex gap-2 mb-3 flex-wrap">
                        <button class="btn btn-success btn-lg" @onclick="HandleApprove" disabled="@isSubmitting" title="Approve this plan and proceed to implementation">
                            @if (isSubmitting)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            }
                            <i class="bi bi-check-circle me-2"></i> Approve Plan
                        </button>
                        <ContextualHelp HelpText="The plan is good. Proceed to implementation (auto or manual based on your settings)." Position="top" />
                        <button class="btn btn-primary btn-lg" @onclick="ShowRefineForm" disabled="@isSubmitting" title="Request specific changes to improve the plan">
                            <i class="bi bi-arrow-repeat me-2"></i> Request Refinements
                        </button>
                        <ContextualHelp HelpText="The plan is mostly good but needs specific improvements. Provide instructions to adjust it while keeping its structure." Position="top" />
                        <button class="btn btn-outline-danger btn-lg" @onclick="ShowRejectForm" disabled="@isSubmitting" title="Reject this plan and start over with new feedback">
                            <i class="bi bi-x-circle me-2"></i> Reject & Regenerate
                        </button>
                        <ContextualHelp HelpText="The plan misses the mark entirely. Start over from scratch with your feedback." Position="top" />
                    </div>
                }
            </div>
        }
        else
        {
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i>
                Plan details are not yet available. Please wait for the plan to be generated.
            </div>
        }

        @if (!string.IsNullOrWhiteSpace(errorMessage))
        {
            <div class="alert alert-danger mt-3">
                <i class="bi bi-exclamation-triangle"></i> @errorMessage
            </div>
        }
    </div>
</div>
    </div>

    <div class="col-lg-4">
        @if (showReviewerAssignment)
        {
            <ReviewerAssignment TicketId="@Ticket.Id"
                              OnAssigned="HandleReviewersAssigned"
                              OnCancel="HideReviewerAssignment" />
        }
        else
        {
            @if (reviewers.Any())
            {
                <PlanReviewStatus Reviewers="@reviewers" />
            }
            else if (!isLoadingReviewers)
            {
                <div class="card mb-3">
                    <div class="card-body text-center">
                        <p class="text-muted mb-3">
                            <i class="bi bi-people me-2"></i>
                            No team reviewers assigned yet.
                        </p>
                        <button class="btn btn-outline-primary btn-sm"
                                @onclick="ShowReviewerAssignment">
                            <i class="bi bi-person-plus me-2"></i>
                            Assign Team Reviewers
                        </button>
                    </div>
                </div>
            }

            <ReviewCommentThread TicketId="@Ticket.Id"
                                Comments="@comments"
                                OnCommentAdded="HandleCommentAdded" />
        }
    </div>
</div>
