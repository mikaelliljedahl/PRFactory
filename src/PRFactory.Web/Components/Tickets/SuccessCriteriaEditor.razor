@using PRFactory.Web.Models
@using PRFactory.Domain.ValueObjects

<div class="success-criteria-editor">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">Success Criteria</h5>
        <button type="button" class="btn btn-sm btn-outline-primary" @onclick="AddCriterion">
            <i class="bi bi-plus-circle me-1"></i> Add Criterion
        </button>
    </div>

    @if (SuccessCriteria == null || !SuccessCriteria.Any())
    {
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> No success criteria defined yet. Click "Add Criterion" to get started.
        </div>
    }
    else
    {
        <div class="criteria-list">
            @for (int i = 0; i < SuccessCriteria.Count; i++)
            {
                var index = i;
                var criterion = SuccessCriteria[index];

                <div class="card mb-2 criterion-card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <label class="form-label">Description</label>
                                <textarea class="form-control form-control-sm"
                                          rows="2"
                                          @bind="criterion.Description"
                                          @bind:event="oninput"
                                          placeholder="What needs to be achieved?"></textarea>
                            </div>

                            <div class="col-md-2 mb-2">
                                <label class="form-label">Category</label>
                                <select class="form-select form-select-sm"
                                        @bind="criterion.Category">
                                    @foreach (var category in Enum.GetValues<SuccessCriterionCategory>())
                                    {
                                        <option value="@category">@category</option>
                                    }
                                </select>
                            </div>

                            <div class="col-md-2 mb-2">
                                <label class="form-label">Priority</label>
                                <select class="form-select form-select-sm"
                                        @bind="criterion.Priority">
                                    <option value="0">Must-Have</option>
                                    <option value="1">Should-Have</option>
                                    <option value="2">Nice-to-Have</option>
                                </select>
                            </div>

                            <div class="col-md-1 mb-2">
                                <label class="form-label">Testable</label>
                                <div class="form-check mt-1">
                                    <input class="form-check-input"
                                           type="checkbox"
                                           @bind="criterion.IsTestable" />
                                </div>
                            </div>

                            <div class="col-md-1 mb-2 d-flex align-items-end">
                                <button type="button"
                                        class="btn btn-sm btn-outline-danger w-100"
                                        @onclick="() => RemoveCriterion(index)"
                                        title="Remove criterion">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    [Parameter]
    public List<SuccessCriterionDto> SuccessCriteria { get; set; } = new();

    [Parameter]
    public EventCallback<List<SuccessCriterionDto>> SuccessCriteriaChanged { get; set; }

    private void AddCriterion()
    {
        SuccessCriteria.Add(new SuccessCriterionDto
        {
            Category = SuccessCriterionCategory.Functional,
            Priority = 0,
            IsTestable = true,
            Description = string.Empty
        });
        NotifyChanged();
    }

    private void RemoveCriterion(int index)
    {
        if (index >= 0 && index < SuccessCriteria.Count)
        {
            SuccessCriteria.RemoveAt(index);
            NotifyChanged();
        }
    }

    private async Task NotifyChanged()
    {
        await SuccessCriteriaChanged.InvokeAsync(SuccessCriteria);
        StateHasChanged();
    }
}

<style>
    .success-criteria-editor {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 1rem;
        background-color: #f8f9fa;
    }

    .criterion-card {
        border-left: 3px solid #0d6efd;
        background-color: white;
    }

    .criteria-list {
        max-height: 500px;
        overflow-y: auto;
    }
</style>
