@page "/errors/{ErrorId:guid}"
@using PRFactory.Web.Models
@using PRFactory.Web.Components.Errors
@using PRFactory.Web.UI.Display
@using PRFactory.Web.UI.Layout
@using PRFactory.Web.UI.Alerts
@using PRFactory.Web.UI.Navigation

<PageTitle>Error Details - PRFactory</PageTitle>

<Breadcrumbs Items="@breadcrumbItems" AdditionalClass="mb-3" />

@if (IsLoading)
{
    <div class="text-center py-5">
        <LoadingSpinner />
        <p class="text-muted mt-3">Loading error details...</p>
    </div>
}
else if (Error == null)
{
    <AlertMessage Type="AlertType.Danger"
                  Icon="exclamation-triangle"
                  Message="Error not found"
                  Dismissible="false" />
    <a href="/errors" class="btn btn-secondary">
        <i class="bi bi-arrow-left me-1"></i>
        Back to Errors
    </a>
}
else
{
    <PageHeader Title="Error Details"
                Icon="exclamation-triangle">
        <Actions>
            <a href="/errors" class="btn btn-secondary">
                <i class="bi bi-arrow-left me-1"></i>
                Back
            </a>
            @if (!Error.IsResolved)
            {
                <button class="btn btn-success" @onclick="ShowResolutionForm">
                    <i class="bi bi-check-circle me-1"></i>
                    Mark as Resolved
                </button>
            }
            @if (Error.EntityType == "Ticket" && Error.EntityId.HasValue)
            {
                <button class="btn btn-warning" @onclick="RetryOperation">
                    <i class="bi bi-arrow-clockwise me-1"></i>
                    Retry Operation
                </button>
                <a href="/tickets/@Error.EntityId" class="btn btn-outline-primary">
                    <i class="bi bi-box-arrow-up-right me-1"></i>
                    View Related Ticket
                </a>
            }
            <button class="btn btn-outline-secondary" @onclick="CopyToClipboard">
                <i class="bi bi-clipboard me-1"></i>
                Copy to Clipboard
            </button>
        </Actions>
    </PageHeader>

        @if (ShowResolution)
        {
            <div class="mb-4">
                <ErrorResolutionForm ErrorId="@Error.Id"
                                     OnSubmit="HandleResolve"
                                     OnCancel="() => ShowResolution = false" />
            </div>
        }

    <ErrorDetail Error="@Error" RelatedErrors="@RelatedErrors" />

    <div class="mt-3">
        <AlertMessage Type="AlertType.Success"
                      Icon="check-circle"
                      Message="@SuccessMessage"
                      Dismissible="true"
                      OnDismiss="() => SuccessMessage = null" />
    </div>

    <div class="mt-3">
        <AlertMessage Type="AlertType.Danger"
                      Icon="exclamation-triangle"
                      Message="@ErrorMessage"
                      Dismissible="true"
                      OnDismiss="() => ErrorMessage = null" />
    </div>
}
