@page "/repositories/{RepositoryId:guid}/edit"
@using PRFactory.Web.Components.Repositories
@using PRFactory.Web.UI.Cards
@using PRFactory.Web.UI.Alerts
@using PRFactory.Web.UI.Display

<PageTitle>Edit Repository - PRFactory</PageTitle>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h1 class="display-6">
                <i class="bi bi-pencil"></i> Edit Repository
            </h1>
            <p class="text-muted">Update repository configuration</p>
        </div>
    </div>

    @if (isLoading)
    {
        <LoadingSpinner IsLoading="true" Message="Loading repository..." />
    }
    else if (repository == null)
    {
        <AlertMessage Type="AlertType.Warning"
                     Title="Not Found"
                     Message="Repository not found."
                     Icon="exclamation-triangle-fill" />
    }
    else
    {
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <AlertMessage Type="AlertType.Danger"
                         Title="Error"
                         Message="@errorMessage"
                         Icon="exclamation-triangle-fill"
                         Dismissible="true"
                         OnDismiss="@(() => errorMessage = null)" />
        }

        @if (!string.IsNullOrEmpty(successMessage))
        {
            <AlertMessage Type="AlertType.Success"
                         Title="Success"
                         Message="@successMessage"
                         Icon="check-circle-fill"
                         Dismissible="true"
                         OnDismiss="@(() => successMessage = null)" />
        }

        <div class="row">
            <div class="col-lg-8">
                <Card Title="Repository Details" Icon="info-circle">
                    <ChildContent>
                        <RepositoryForm Model="@model"
                                       IsEditMode="true"
                                       ShowTenantSelection="false"
                                       OnValidSubmit="@HandleValidSubmit"
                                       OnCancel="@HandleCancel"
                                       IsSubmitting="@isSubmitting"
                                       SubmitButtonText="Save Changes" />
                    </ChildContent>
                </Card>

                <RepositoryConnectionTest CloneUrl="@model.CloneUrl"
                                         AccessToken="@(string.IsNullOrEmpty(model.AccessToken) ? "***" : model.AccessToken)" />
            </div>

            <div class="col-lg-4">
                <Card Title="Repository Information" Icon="info-circle" AdditionalClass="mb-3">
                    <ChildContent>
                        <div class="mb-3">
                            <small class="text-muted">Repository ID</small>
                            <div><code>@repository.Id</code></div>
                        </div>

                        <div class="mb-3">
                            <small class="text-muted">Tenant</small>
                            <div>@repository.TenantName</div>
                        </div>

                        <div class="mb-3">
                            <small class="text-muted">Created</small>
                            <div>@repository.CreatedAt.ToLocalTime().ToString("g")</div>
                        </div>

                        @if (repository.UpdatedAt.HasValue)
                        {
                            <div class="mb-3">
                                <small class="text-muted">Last Updated</small>
                                <div>@repository.UpdatedAt.Value.ToLocalTime().ToString("g")</div>
                            </div>
                        }

                        @if (repository.LastAccessedAt.HasValue)
                        {
                            <div class="mb-3">
                                <small class="text-muted">Last Accessed</small>
                                <div>
                                    <RelativeTime Timestamp="@repository.LastAccessedAt.Value" />
                                </div>
                            </div>
                        }

                        <div class="mb-0">
                            <small class="text-muted">Associated Tickets</small>
                            <div>
                                <span class="badge bg-primary">@repository.TicketCount</span>
                            </div>
                        </div>
                    </ChildContent>
                </Card>
            </div>
        </div>
    }
</div>
