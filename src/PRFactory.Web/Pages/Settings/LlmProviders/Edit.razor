@page "/settings/llm-providers/edit/{id:guid}"
@attribute [Authorize(Roles = "Owner,Admin")]

<PageTitle>Edit LLM Provider - PRFactory</PageTitle>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/settings/llm-providers">LLM Providers</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Edit</li>
                </ol>
            </nav>
            <h1 class="display-6">
                <i class="bi bi-pencil"></i> Edit LLM Provider
            </h1>
        </div>
    </div>

    @if (isLoading)
    {
        <LoadingSpinner Message="Loading provider..." />
    }
    else if (provider == null)
    {
        <AlertMessage Type="AlertType.Danger"
                     Message="Provider not found or you don't have permission to edit it." />
    }
    else if (updateModel != null)
    {
        <Card Title="@($"Edit {provider.Name}")" Icon="bi-gear">
            <EditForm EditContext="editContext" OnValidSubmit="HandleSubmitAsync">
                <DataAnnotationsValidator />

                @* Provider Name *@
                <FormTextField Label="Provider Name"
                              Value="@updateModel.Name"
                              Placeholder="Production Z.ai"
                              Required="true"
                              HelpText="A friendly name for this provider"
                              @onchange="@((ChangeEventArgs e) => updateModel.Name = e.Value?.ToString() ?? string.Empty)" />

                @* API Base URL (if not OAuth) *@
                @if (!provider.UsesOAuth)
                {
                    <FormTextField Label="API Base URL"
                                  Value="@updateModel.ApiBaseUrl"
                                  Placeholder="https://api.example.com/v1"
                                  HelpText="Base URL for the API endpoint"
                                  @onchange="@((ChangeEventArgs e) => updateModel.ApiBaseUrl = e.Value?.ToString())" />
                }

                @* Default Model *@
                <FormTextField Label="Default Model"
                              Value="@updateModel.DefaultModel"
                              Placeholder="gpt-4o"
                              Required="true"
                              HelpText="Default model to use for requests"
                              @onchange="@((ChangeEventArgs e) => updateModel.DefaultModel = e.Value?.ToString() ?? string.Empty)" />

                @* Timeout *@
                <div class="mb-3">
                    <label class="form-label">Timeout (milliseconds) *</label>
                    <input type="number"
                           class="form-control"
                           @bind="updateModel.TimeoutMs"
                           placeholder="300000"
                           min="1000"
                           max="600000" />
                    <small class="form-text text-muted">Request timeout in milliseconds (default: 300000 = 5 minutes)</small>
                </div>

                @* Model Overrides (if not OAuth) *@
                @if (!provider.UsesOAuth)
                {
                    <ModelOverridesEditor Value="updateModel.ModelOverrides"
                                         ValueChanged="@((Dictionary<string, string>? value) => updateModel.ModelOverrides = value)"
                                         HelpText="Map generic model names to provider-specific names (optional)" />

                    @* Disable Non-Essential Traffic *@
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="disableNonEssentialTraffic"
                               @bind="updateModel.DisableNonEssentialTraffic" />
                        <label class="form-check-label" for="disableNonEssentialTraffic">
                            Disable Non-Essential Traffic
                        </label>
                        <small class="form-text text-muted d-block">
                            Skip non-essential API calls to reduce costs
                        </small>
                    </div>
                }

                @* Active Status *@
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="isActive"
                           @bind="updateModel.IsActive" />
                    <label class="form-check-label" for="isActive">
                        Provider is active
                    </label>
                    <small class="form-text text-muted d-block">
                        Inactive providers cannot be used by agents
                    </small>
                </div>

                @* Action Buttons *@
                <div class="d-flex gap-2">
                    <button type="submit"
                            class="btn btn-primary"
                            disabled="@isSaving">
                        @if (isSaving)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            <span>Updating...</span>
                        }
                        else
                        {
                            <i class="bi bi-save me-2"></i>
                            <span>Update Provider</span>
                        }
                    </button>

                    <button type="button" class="btn btn-secondary" @onclick="HandleCancel">
                        Cancel
                    </button>
                </div>
            </EditForm>
        </Card>
    }
</div>
