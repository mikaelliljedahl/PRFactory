@page "/settings/users/edit/{id:guid}"
@attribute [Authorize(Roles = "Owner")]
@using PRFactory.Web.Components.Settings
@using PRFactory.Web.UI.Display
@using PRFactory.Web.UI.Cards
@using PRFactory.Web.UI.Buttons
@using PRFactory.Domain.Entities
@using Microsoft.AspNetCore.Authorization

<PageTitle>Edit User - PRFactory</PageTitle>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/settings/users">Users</a></li>
                    <li class="breadcrumb-item active">Edit</li>
                </ol>
            </nav>
            <h1 class="display-6">
                <i class="bi bi-pencil"></i> Edit User
            </h1>
        </div>
    </div>

    @if (isLoading)
    {
        <LoadingSpinner IsLoading="true" Message="Loading user..." />
    }
    else if (user != null)
    {
        <Card Title="@user.DisplayName" Icon="person">
            <div class="row mb-3">
                <div class="col-md-6">
                    <dl>
                        <dt>Email</dt>
                        <dd>@user.Email</dd>

                        <dt>Identity Provider</dt>
                        <dd>@user.IdentityProvider</dd>

                        <dt>Created</dt>
                        <dd><RelativeTime Timestamp="user.CreatedAt" /></dd>
                    </dl>
                </div>
                <div class="col-md-6">
                    @if (!string.IsNullOrEmpty(user.AvatarUrl))
                    {
                        <img src="@user.AvatarUrl" alt="@user.DisplayName"
                             class="rounded-circle" width="100" height="100" />
                    }
                    else
                    {
                        <div class="avatar-placeholder rounded-circle"
                             style="width: 100px; height: 100px; background: #e0e0e0; display: flex; align-items: center; justify-content: center;">
                            <i class="bi bi-person" style="font-size: 50px; color: #666;"></i>
                        </div>
                    }
                </div>
            </div>

            <hr />

            <UserRoleEditor SelectedRole="@selectedRole"
                           IsActive="@isActive"
                           CurrentUser="user"
                           OnRoleChanged="@((role) => selectedRole = role)"
                           OnActiveChanged="@((active) => isActive = active)" />

            <hr />

            <div class="d-flex gap-2">
                <LoadingButton Text="Save Changes"
                              Icon="save"
                              OnClick="@(async _ => await HandleSaveAsync())"
                              IsLoading="isSaving"
                              LoadingText="Saving..."
                              Variant="ButtonVariant.Primary" />

                <button type="button" class="btn btn-secondary" @onclick="HandleCancel">
                    Cancel
                </button>
            </div>
        </Card>
    }
</div>
