@page "/tickets/{id}"
@using Microsoft.AspNetCore.SignalR.Client
@using PRFactory.Web.Models
@using PRFactory.Web.Components.Tickets
@using PRFactory.Web.Components.Agents
@using PRFactory.Web.UI.Alerts
@using PRFactory.Web.UI.Cards
@using PRFactory.Web.UI.Display
@using PRFactory.Web.UI.Navigation
@using PRFactory.Web.UI.Layout
@using PRFactory.Domain.ValueObjects

<PageTitle>@(ticket != null ? $"{ticket.TicketKey} - PRFactory" : "Loading...")</PageTitle>

@if (ticket != null)
{
    <Breadcrumbs Items="@breadcrumbItems" AdditionalClass="mb-3" />

    <PageHeader Title="@ticket.TicketKey"
                Subtitle="@ticket.Title"
                Icon="ticket">
        <Actions>
            <button class="btn btn-outline-secondary" @onclick="@(() => NavigationManager.NavigateTo("/"))">
                <i class="bi bi-arrow-left me-2"></i>Back to Dashboard
            </button>
        </Actions>
    </PageHeader>
}

@if (isLoading)
{
    <LoadingSpinner IsLoading="true" Message="Loading ticket details..." />
}
else if (errorMessage != null)
{
    <AlertMessage Type="AlertType.Danger" Message="@errorMessage" Icon="exclamation-triangle" />
    <button class="btn btn-primary" @onclick="@(() => NavigationManager.NavigateTo("/"))">
        <i class="bi bi-arrow-left"></i> Back to Dashboard
    </button>
}
else if (ticket == null)
{
    <AlertMessage Type="AlertType.Warning" Message="Ticket not found" Icon="info-circle" />
    <button class="btn btn-primary" @onclick="@(() => NavigationManager.NavigateTo("/"))">
        <i class="bi bi-arrow-left"></i> Back to Dashboard
    </button>
}
else
{
    @if (connectionState != HubConnectionState.Connected)
    {
        <AlertMessage Type="@GetConnectionAlertType()"
                      Icon="@GetConnectionIcon()"
                      Title="@GetConnectionStatusText()"
                      Message="@(connectionState == HubConnectionState.Disconnected ? "Real-time updates unavailable. Please refresh to see latest changes." : "")"
                      Dismissible="false" />
    }

    <GridLayout Columns="8,4">
        <GridColumn>
                <TicketHeader Ticket="@ticket" />

                @if (ticket.State == WorkflowState.TicketUpdateUnderReview || ticket.State == WorkflowState.TicketUpdateGenerated)
                {
                    <TicketUpdatePreview TicketId="@ticket.Id"
                                        OriginalTicket="@ticket"
                                        OnUpdateApproved="HandleTicketUpdateApproved"
                                        OnUpdateRejected="HandleTicketUpdateRejected" />
                }
                else if (ticket.State == WorkflowState.QuestionsPosted || ticket.State == WorkflowState.AwaitingAnswers)
                {
                    <QuestionAnswerForm TicketId="@ticket.Id"
                                      Questions="@questions"
                                      OnAnswersSubmitted="HandleAnswersSubmitted" />
                }
                else if (ticket.State == WorkflowState.PlanPosted || ticket.State == WorkflowState.PlanUnderReview)
                {
                    <PlanReviewSection Ticket="@ticket"
                                     OnPlanApproved="HandlePlanApproved"
                                     OnPlanRejected="HandlePlanRejected" />
                }
                else if (ticket.State == WorkflowState.PRCreated || ticket.State == WorkflowState.InReview)
                {
                    <Card Title="Pull Request Created" Icon="git" Variant="CardVariant.Success">
                        <p>A pull request has been created for this ticket.</p>
                        @if (!string.IsNullOrEmpty(ticket.PullRequestUrl))
                        {
                            <a href="@ticket.PullRequestUrl" target="_blank" class="btn btn-primary">
                                <i class="bi bi-box-arrow-up-right"></i> View Pull Request
                            </a>
                        }
                    </Card>
                }
                else if (ticket.State == WorkflowState.Completed)
                {
                    <Card Title="Ticket Completed" Icon="check-circle" Variant="CardVariant.Success">
                        <p>This ticket has been successfully completed and merged.</p>
                        @if (ticket.CompletedAt.HasValue)
                        {
                            <p class="text-muted">
                                <small>Completed on @ticket.CompletedAt.Value.ToString("g")</small>
                            </p>
                        }
                        @if (!string.IsNullOrEmpty(ticket.PullRequestUrl))
                        {
                            <a href="@ticket.PullRequestUrl" target="_blank" class="btn btn-outline-primary">
                                <i class="bi bi-box-arrow-up-right"></i> View Pull Request
                            </a>
                        }
                    </Card>
                }
                else if (ticket.State == WorkflowState.Failed)
                {
                    <Card Title="Workflow Failed" Icon="exclamation-triangle" Variant="CardVariant.Danger">
                        <p>The workflow encountered an error and could not complete.</p>
                        @if (!string.IsNullOrEmpty(ticket.LastError))
                        {
                            <AlertMessage Type="AlertType.Danger" Title="Error" Message="@ticket.LastError" />
                        }
                    </Card>
                }
                else if (ticket.State == WorkflowState.Cancelled)
                {
                    <Card Title="Ticket Cancelled" Icon="x-circle" Variant="CardVariant.Secondary">
                        <p>This ticket has been cancelled and will not be processed.</p>
                    </Card>
                }
                else
                {
                    <Card Title="In Progress" Icon="hourglass-split">
                        <p>The workflow is currently processing this ticket.</p>
                        <p class="text-muted">Current state: <strong>@ticket.StateDisplay</strong></p>
                    </Card>
                }
        </GridColumn>

        <GridColumn>
            <WorkflowTimeline Ticket="@ticket" Events="@events" />
        </GridColumn>
    </GridLayout>

    <Section Title="Agent Assistant" Icon="robot">
        <AgentChat TicketId="@ticket.Id" />
    </Section>
}
