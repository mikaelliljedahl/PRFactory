@page "/tickets"
@using Microsoft.AspNetCore.SignalR.Client
@using PRFactory.Web.Models
@using PRFactory.Web.Components
@using PRFactory.Web.UI.Alerts
@using PRFactory.Web.UI.Buttons
@using PRFactory.Web.UI.Display
@using PRFactory.Web.UI.Navigation
@using PRFactory.Domain.ValueObjects
@using static PRFactory.Web.Components.TicketFilters
@using ButtonSize = PRFactory.Web.UI.Buttons.ButtonSize

<PageTitle>Tickets - PRFactory</PageTitle>

<Breadcrumbs Items="@breadcrumbItems" AdditionalClass="mb-3" />

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h1 class="display-6">
                <i class="bi bi-ticket-perforated"></i> Tickets
            </h1>
            <p class="text-muted">Manage and track your PRFactory tickets</p>
        </div>
        <div class="col-auto align-self-center">
            <a href="/tickets/create" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Create New Ticket
            </a>
        </div>
    </div>

    <!-- Filters -->
    <TicketFilters
        SelectedState="@filterState"
        SelectedStateChanged="OnStateFilterChanged"
        SelectedSource="@filterSource"
        SelectedSourceChanged="OnSourceFilterChanged"
        SelectedRepositoryId="@filterRepositoryId"
        SelectedRepositoryIdChanged="OnRepositoryFilterChanged"
        OnFilterChanged="LoadTicketsAsync"
        Repositories="@repositories" />

    <!-- Loading State -->
    @if (isLoading)
    {
        <LoadingSpinner IsLoading="true" Message="Loading tickets..." />
    }
    else if (errorMessage != null)
    {
        <!-- Error State -->
        <AlertMessage Type="AlertType.Danger" Title="Error" Message="@errorMessage" Icon="exclamation-triangle-fill">
            <IconButton Icon="arrow-clockwise" Text="Retry" Variant="ButtonVariant.OutlineDanger" Size="ButtonSize.Small" AdditionalClass="ms-3" OnClick="@(async _ => await LoadTicketsAsync())" />
        </AlertMessage>
    }
    else if (tickets == null || !tickets.Any())
    {
        <!-- Empty State -->
        <EmptyState Icon="inbox"
                    Title="No tickets found"
                    Message="Create your first ticket to get started"
                    ActionUrl="/tickets/create"
                    ActionText="Create New Ticket"
                    ActionIcon="plus-circle" />
    }
    else
    {
        <!-- Tickets Grid -->
        <div class="row mb-4">
            @foreach (var ticket in tickets)
            {
                <div class="col-md-6 col-lg-4 mb-4">
                    <TicketListItem Ticket="@ticket" />
                </div>
            }
        </div>

        <!-- Pagination -->
        <Pagination
            CurrentPage="@currentPage"
            TotalPages="@totalPages"
            TotalItems="@totalItems"
            OnPageChanged="OnPageChangedAsync" />
    }

    <!-- Real-time Connection Status -->
    @if (hubConnection != null)
    {
        <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1000;">
            <div class="toast show" role="alert">
                <div class="toast-body">
                    @if (hubConnection.State == HubConnectionState.Connected)
                    {
                        <i class="bi bi-check-circle-fill text-success"></i>
                        <span class="text-success">Real-time updates active</span>
                    }
                    else if (hubConnection.State == HubConnectionState.Connecting || hubConnection.State == HubConnectionState.Reconnecting)
                    {
                        <i class="bi bi-arrow-repeat text-warning"></i>
                        <span class="text-warning">Connecting...</span>
                    }
                    else
                    {
                        <i class="bi bi-x-circle-fill text-danger"></i>
                        <span class="text-danger">Disconnected</span>
                    }
                </div>
            </div>
        </div>
    }
</div>
