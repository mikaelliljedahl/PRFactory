@page "/tickets"
@using Microsoft.AspNetCore.SignalR.Client
@using PRFactory.Web.Models
@using PRFactory.Web.Components
@using PRFactory.Domain.ValueObjects
@using static PRFactory.Web.Components.TicketFilters
@inject ITicketService TicketService
@inject IRepositoryService RepositoryService
@inject NavigationManager NavigationManager
@inject ILogger<Index> Logger
@implements IAsyncDisposable

<PageTitle>Tickets - PRFactory</PageTitle>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h1 class="display-6">
                <i class="bi bi-ticket-perforated"></i> Tickets
            </h1>
            <p class="text-muted">Manage and track your PRFactory tickets</p>
        </div>
        <div class="col-auto align-self-center">
            <a href="/tickets/create" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Create New Ticket
            </a>
        </div>
    </div>

    <!-- Filters -->
    <TicketFilters
        SelectedState="@filterState"
        SelectedStateChanged="OnStateFilterChanged"
        SelectedSource="@filterSource"
        SelectedSourceChanged="OnSourceFilterChanged"
        SelectedRepositoryId="@filterRepositoryId"
        SelectedRepositoryIdChanged="OnRepositoryFilterChanged"
        OnFilterChanged="LoadTicketsAsync"
        Repositories="@repositories" />

    <!-- Loading State -->
    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Loading tickets...</p>
        </div>
    }
    else if (errorMessage != null)
    {
        <!-- Error State -->
        <div class="alert alert-danger" role="alert">
            <i class="bi bi-exclamation-triangle-fill"></i>
            <strong>Error:</strong> @errorMessage
            <button class="btn btn-sm btn-outline-danger ms-3" @onclick="LoadTicketsAsync">
                <i class="bi bi-arrow-clockwise"></i> Retry
            </button>
        </div>
    }
    else if (tickets == null || !tickets.Any())
    {
        <!-- Empty State -->
        <div class="text-center py-5">
            <i class="bi bi-inbox" style="font-size: 4rem; color: #ccc;"></i>
            <h3 class="mt-3 text-muted">No tickets found</h3>
            <p class="text-muted">Create your first ticket to get started</p>
            <a href="/tickets/create" class="btn btn-primary mt-3">
                <i class="bi bi-plus-circle"></i> Create New Ticket
            </a>
        </div>
    }
    else
    {
        <!-- Tickets Grid -->
        <div class="row mb-4">
            @foreach (var ticket in tickets)
            {
                <div class="col-md-6 col-lg-4 mb-4">
                    <TicketListItem Ticket="@ticket" />
                </div>
            }
        </div>

        <!-- Pagination -->
        <Pagination
            CurrentPage="@currentPage"
            TotalPages="@totalPages"
            TotalItems="@totalItems"
            OnPageChanged="OnPageChangedAsync" />
    }

    <!-- Real-time Connection Status -->
    @if (hubConnection != null)
    {
        <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1000;">
            <div class="toast show" role="alert">
                <div class="toast-body">
                    @if (hubConnection.State == HubConnectionState.Connected)
                    {
                        <i class="bi bi-check-circle-fill text-success"></i>
                        <span class="text-success">Real-time updates active</span>
                    }
                    else if (hubConnection.State == HubConnectionState.Connecting || hubConnection.State == HubConnectionState.Reconnecting)
                    {
                        <i class="bi bi-arrow-repeat text-warning"></i>
                        <span class="text-warning">Connecting...</span>
                    }
                    else
                    {
                        <i class="bi bi-x-circle-fill text-danger"></i>
                        <span class="text-danger">Disconnected</span>
                    }
                </div>
            </div>
        </div>
    }
</div>

@code {
    private List<TicketDto>? tickets;
    private List<RepositoryInfo>? repositories;
    private HubConnection? hubConnection;

    private int currentPage = 1;
    private int totalPages = 1;
    private int? totalItems;
    private int pageSize = 12;

    private string? filterState;
    private string? filterSource;
    private string? filterRepositoryId;

    private bool isLoading = true;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadRepositoriesAsync();
        await LoadTicketsAsync();
        await InitializeSignalRAsync();
    }

    private async Task LoadRepositoriesAsync()
    {
        try
        {
            var allRepos = await RepositoryService.GetAllRepositoriesAsync();
            repositories = allRepos.Select(r => new RepositoryInfo
            {
                Id = r.Id,
                Name = r.Name
            }).ToList();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading repositories");
            // Non-critical, just log the error
        }
    }

    private async Task LoadTicketsAsync()
    {
        try
        {
            isLoading = true;
            errorMessage = null;
            StateHasChanged();

            // TODO: Replace with actual API call that supports filtering and pagination
            // For now, load all tickets and filter/paginate in memory
            var allTickets = await TicketService.GetAllTicketsAsync();

            // Map to DTOs
            var ticketDtos = allTickets.Select(t => new TicketDto
            {
                Id = t.Id,
                TicketKey = t.TicketKey,
                Title = t.Title,
                Description = t.Description,
                State = t.State,
                Source = t.Source,
                RepositoryId = t.RepositoryId,
                RepositoryName = t.Repository?.Name,
                CreatedAt = t.CreatedAt,
                UpdatedAt = t.UpdatedAt,
                CompletedAt = t.CompletedAt,
                PullRequestUrl = t.PullRequestUrl,
                PullRequestNumber = t.PullRequestNumber,
                LastError = t.LastError
            }).ToList();

            // Apply filters
            var filteredTickets = ApplyFilters(ticketDtos);

            // Calculate pagination
            totalItems = filteredTickets.Count;
            totalPages = (int)Math.Ceiling((double)totalItems.Value / pageSize);
            currentPage = Math.Max(1, Math.Min(currentPage, totalPages));

            // Apply pagination
            tickets = filteredTickets
                .Skip((currentPage - 1) * pageSize)
                .Take(pageSize)
                .ToList();

            Logger.LogInformation("Loaded {Count} tickets (page {Page} of {Total})",
                tickets.Count, currentPage, totalPages);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading tickets");
            errorMessage = "Failed to load tickets. Please try again.";
            tickets = new List<TicketDto>();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private List<TicketDto> ApplyFilters(List<TicketDto> allTickets)
    {
        var filtered = allTickets.AsEnumerable();

        // Filter by state
        if (!string.IsNullOrWhiteSpace(filterState) && Enum.TryParse<WorkflowState>(filterState, out var state))
        {
            filtered = filtered.Where(t => t.State == state);
        }

        // Filter by source
        if (!string.IsNullOrWhiteSpace(filterSource) && Enum.TryParse<TicketSource>(filterSource, out var source))
        {
            filtered = filtered.Where(t => t.Source == source);
        }

        // Filter by repository
        if (!string.IsNullOrWhiteSpace(filterRepositoryId) && Guid.TryParse(filterRepositoryId, out var repoId))
        {
            filtered = filtered.Where(t => t.RepositoryId == repoId);
        }

        return filtered.OrderByDescending(t => t.CreatedAt).ToList();
    }

    private async Task OnPageChangedAsync(int page)
    {
        currentPage = page;
        await LoadTicketsAsync();
    }

    private async Task OnStateFilterChanged(string? value)
    {
        filterState = value;
        currentPage = 1; // Reset to first page when filter changes
        await LoadTicketsAsync();
    }

    private async Task OnSourceFilterChanged(string? value)
    {
        filterSource = value;
        currentPage = 1;
        await LoadTicketsAsync();
    }

    private async Task OnRepositoryFilterChanged(string? value)
    {
        filterRepositoryId = value;
        currentPage = 1;
        await LoadTicketsAsync();
    }

    private async Task InitializeSignalRAsync()
    {
        try
        {
            // Build the SignalR hub connection
            hubConnection = new HubConnectionBuilder()
                .WithUrl(NavigationManager.ToAbsoluteUri("/hubs/tickets"))
                .WithAutomaticReconnect()
                .Build();

            // Subscribe to ticket update events
            hubConnection.On<Guid, string>("TicketUpdated", async (ticketId, state) =>
            {
                Logger.LogInformation("Received SignalR update for ticket {TicketId}: {State}", ticketId, state);

                // Reload the tickets to reflect the update
                await LoadTicketsAsync();
            });

            // Subscribe to ticket created events
            hubConnection.On<Guid>("TicketCreated", async (ticketId) =>
            {
                Logger.LogInformation("Received SignalR notification for new ticket {TicketId}", ticketId);

                // Reload the tickets to show the new ticket
                await LoadTicketsAsync();
            });

            // Start the connection
            await hubConnection.StartAsync();
            Logger.LogInformation("SignalR connection established");

            // Subscribe to all ticket updates
            await hubConnection.InvokeAsync("SubscribeToAllTickets");
            Logger.LogInformation("Subscribed to all ticket updates");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error initializing SignalR connection");
            // Non-critical error, continue without real-time updates
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (hubConnection != null)
        {
            try
            {
                await hubConnection.InvokeAsync("UnsubscribeFromAllTickets");
                await hubConnection.DisposeAsync();
                Logger.LogInformation("SignalR connection disposed");
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error disposing SignalR connection");
            }
        }
    }
}
