@page "/workflows/events"
@using PRFactory.Web.Models
@using PRFactory.Web.Components.Workflows
@using PRFactory.Web.UI.Alerts
@using PRFactory.Web.UI.Buttons
@using PRFactory.Web.UI.Cards
@using PRFactory.Web.UI.Display
@using Radzen.Blazor

<PageTitle>Event Log - PRFactory</PageTitle>

<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col">
            <h1 class="display-6">
                <i class="bi bi-calendar-event"></i> Workflow Event Log
            </h1>
            <p class="text-muted">View and analyze workflow events across all tickets</p>
        </div>
        <div class="col-auto">
            <div class="btn-group">
                <button type="button"
                        class="btn @(autoRefresh ? "btn-success" : "btn-outline-secondary")"
                        @onclick="ToggleAutoRefresh">
                    <i class="bi bi-@(autoRefresh ? "pause" : "play")-fill me-2"></i>
                    @(autoRefresh ? "Auto-refresh ON" : "Auto-refresh OFF")
                </button>
                <button type="button" class="btn btn-outline-primary" @onclick="RefreshData" disabled="@isLoading">
                    <i class="bi bi-arrow-clockwise me-2"></i>Refresh
                </button>
                <button type="button" class="btn btn-outline-success" @onclick="ExportToCsv" disabled="@isLoading">
                    <i class="bi bi-file-earmark-spreadsheet me-2"></i>Export CSV
                </button>
                <button type="button" class="btn btn-outline-info" @onclick="ExportToJson" disabled="@isLoading">
                    <i class="bi bi-file-earmark-code me-2"></i>Export JSON
                </button>
            </div>
        </div>
    </div>

    <!-- Statistics -->
    @if (statistics != null)
    {
        <EventStatistics Statistics="@statistics" />
    }

    <!-- Loading State -->
    @if (isLoading && pagedResult == null)
    {
        <LoadingSpinner IsLoading="true" Message="Loading events..." />
    }
    else if (errorMessage != null)
    {
        <!-- Error State -->
        <AlertMessage Type="AlertType.Danger" Title="Error" Message="@errorMessage" Icon="exclamation-triangle-fill">
            <IconButton Icon="arrow-clockwise" Text="Retry" Variant="ButtonVariant.OutlineDanger" Size="ButtonSize.Small" AdditionalClass="ms-3" OnClick="@(async _ => await RefreshData())" />
        </AlertMessage>
    }
    else
    {
        <div class="row mt-4">
            <!-- Filters Sidebar -->
            <div class="col-md-3">
                <EventLogFilter EventTypes="@eventTypes"
                                @bind-SelectedEventType="selectedEventType"
                                @bind-DateRange="dateRange"
                                @bind-SelectedSeverity="selectedSeverity"
                                @bind-SearchText="searchText"
                                OnFilterChange="@OnFilterChanged" />
            </div>

            <!-- Events Grid and Detail -->
            <div class="col-md-9">
                @if (pagedResult == null || !pagedResult.Items.Any())
                {
                    <!-- Empty State -->
                    <EmptyState Icon="calendar-x"
                                Title="No events found"
                                Message="No workflow events match the current filters. Try adjusting your filters or refresh the data."
                                ActionText="Clear Filters"
                                ActionIcon="x-circle"
                                OnActionClick="@ClearAllFilters" />
                }
                else
                {
                    <!-- Events Table -->
                    <Card Title="@GetEventsTitle()" Icon="list-ul">
                        <ChildContent>
                            <RadzenDataGrid Data="@pagedResult.Items"
                                        TItem="WorkflowEventDto"
                                        AllowVirtualization="true"
                                        Style="height: 600px"
                                        AllowRowSelectOnRowClick="true"
                                        SelectionMode="DataGridSelectionMode.Single"
                                        @bind-Value="@selectedEvents"
                                        RowClick="@OnRowClick"
                                        Density="Density.Compact">
                            <Columns>
                                <RadzenDataGridColumn TItem="WorkflowEventDto" Property="OccurredAt" Title="Time" Width="180px" Sortable="true">
                                    <Template Context="evt">
                                        <div>
                                            @evt.OccurredAt.ToString("MM/dd HH:mm:ss")
                                            <div class="text-muted small">
                                                <RelativeTime Timestamp="@evt.OccurredAt" />
                                            </div>
                                        </div>
                                    </Template>
                                </RadzenDataGridColumn>

                                <RadzenDataGridColumn TItem="WorkflowEventDto" Property="EventType" Title="Event Type" Width="200px" Sortable="true">
                                    <Template Context="evt">
                                        <span class="badge bg-light text-dark">@evt.EventType</span>
                                    </Template>
                                </RadzenDataGridColumn>

                                <RadzenDataGridColumn TItem="WorkflowEventDto" Property="Severity" Title="Severity" Width="120px" Sortable="true">
                                    <Template Context="evt">
                                        <span class="badge @GetSeverityBadgeClass(evt.Severity)">
                                            <i class="bi bi-@evt.Icon me-1"></i>@evt.Severity
                                        </span>
                                    </Template>
                                </RadzenDataGridColumn>

                                <RadzenDataGridColumn TItem="WorkflowEventDto" Property="TicketKey" Title="Ticket" Width="120px" Sortable="true">
                                    <Template Context="evt">
                                        @if (!string.IsNullOrEmpty(evt.TicketKey))
                                        {
                                            <a href="/tickets/@evt.TicketId">@evt.TicketKey</a>
                                        }
                                        else
                                        {
                                            <span class="text-muted">N/A</span>
                                        }
                                    </Template>
                                </RadzenDataGridColumn>

                                <RadzenDataGridColumn TItem="WorkflowEventDto" Property="Description" Title="Description" Sortable="false">
                                    <Template Context="evt">
                                        @evt.Description
                                    </Template>
                                </RadzenDataGridColumn>

                                <RadzenDataGridColumn TItem="WorkflowEventDto" Title="Actions" Width="100px" Sortable="false">
                                    <Template Context="evt">
                                        <button type="button"
                                                class="btn btn-sm btn-outline-primary"
                                                @onclick="@(() => ViewEventDetail(evt))">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </Template>
                                </RadzenDataGridColumn>
                            </Columns>
                        </RadzenDataGrid>
                        </ChildContent>

                        <FooterContent>
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <div>
                                    Showing @pagedResult.Items.Count of @pagedResult.TotalCount events
                                </div>
                                <nav aria-label="Event pagination">
                                    <ul class="pagination mb-0">
                                        <li class="page-item @(pagedResult.HasPreviousPage ? "" : "disabled")">
                                            <button class="page-link" @onclick="PreviousPage" disabled="@(!pagedResult.HasPreviousPage)">
                                                Previous
                                            </button>
                                        </li>
                                        @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(pagedResult.TotalPages, currentPage + 2); i++)
                                        {
                                            var pageNum = i;
                                            <li class="page-item @(currentPage == pageNum ? "active" : "")">
                                                <button class="page-link" @onclick="@(() => GoToPage(pageNum))">@pageNum</button>
                                            </li>
                                        }
                                        <li class="page-item @(pagedResult.HasNextPage ? "" : "disabled")">
                                            <button class="page-link" @onclick="NextPage" disabled="@(!pagedResult.HasNextPage)">
                                                Next
                                            </button>
                                        </li>
                                    </ul>
                                </nav>
                            </div>
                        </FooterContent>
                    </Card>

                    <!-- Event Detail Panel -->
                    @if (selectedEvent != null)
                    {
                        <div class="mt-3">
                            <EventDetail Event="@selectedEvent" />
                        </div>
                    }
                }
            </div>
        </div>
    }
</div>
