@using System.Linq.Expressions

<div class="mb-3">
    <label for="@FieldId" class="form-label">
        @Label
        @if (Required)
        {
            <span class="text-danger">*</span>
        }
    </label>
    <div class="input-group">
        <input
            type="@(showPassword ? "text" : "password")"
            id="@FieldId"
            class="form-control @(IsInvalid ? "is-invalid" : "")"
            value="@Value"
            @oninput="OnInputChanged"
            placeholder="@Placeholder"
            disabled="@Disabled"
            required="@Required" />
        <button
            class="btn btn-outline-secondary"
            type="button"
            @onclick="TogglePasswordVisibility"
            disabled="@Disabled">
            <i class="bi bi-@(showPassword ? "eye-slash" : "eye")"></i>
        </button>
    </div>

    @if (For != null)
    {
        <ValidationMessage For="@For" />
    }

    @if (!string.IsNullOrEmpty(HelpText))
    {
        <small class="form-text text-muted">@HelpText</small>
    }

    @if (ShowStrengthIndicator && !string.IsNullOrEmpty(Value))
    {
        <div class="mt-2">
            <small class="text-muted">Password Strength:</small>
            <div class="progress" style="height: 5px;">
                <div class="progress-bar @StrengthColorClass"
                     role="progressbar"
                     style="width: @(PasswordStrength * 25)%"
                     aria-valuenow="@PasswordStrength"
                     aria-valuemin="0"
                     aria-valuemax="4"></div>
            </div>
            <small class="@StrengthTextClass">@StrengthText</small>
        </div>
    }
</div>

@code {
    [Parameter, EditorRequired]
    public string Label { get; set; } = null!;

    [Parameter]
    public string? Id { get; set; }

    [Parameter]
    public string? Value { get; set; }

    [Parameter]
    public EventCallback<string?> ValueChanged { get; set; }

    [Parameter]
    public bool Required { get; set; }

    [Parameter]
    public string? Placeholder { get; set; }

    [Parameter]
    public string? HelpText { get; set; }

    [Parameter]
    public bool Disabled { get; set; }

    [Parameter]
    public Expression<Func<string?>>? For { get; set; }

    [Parameter]
    public bool IsInvalid { get; set; }

    [Parameter]
    public bool ShowStrengthIndicator { get; set; }

    private string FieldId => Id ?? $"field-{Label.Replace(" ", "-").ToLower()}";
    private bool showPassword = false;

    private void TogglePasswordVisibility()
    {
        showPassword = !showPassword;
    }

    private async Task OnInputChanged(ChangeEventArgs e)
    {
        Value = e.Value?.ToString();
        await ValueChanged.InvokeAsync(Value);
    }

    private int PasswordStrength
    {
        get
        {
            if (string.IsNullOrEmpty(Value)) return 0;

            int strength = 0;
            if (Value.Length >= 8) strength++;
            if (Value.Any(char.IsUpper)) strength++;
            if (Value.Any(char.IsLower)) strength++;
            if (Value.Any(char.IsDigit)) strength++;
            if (Value.Any(c => !char.IsLetterOrDigit(c))) strength++;

            return Math.Min(strength, 4);
        }
    }

    private string StrengthColorClass => PasswordStrength switch
    {
        1 => "bg-danger",
        2 => "bg-warning",
        3 => "bg-info",
        4 => "bg-success",
        _ => "bg-secondary"
    };

    private string StrengthTextClass => PasswordStrength switch
    {
        1 => "text-danger",
        2 => "text-warning",
        3 => "text-info",
        4 => "text-success",
        _ => "text-muted"
    };

    private string StrengthText => PasswordStrength switch
    {
        1 => "Weak",
        2 => "Fair",
        3 => "Good",
        4 => "Strong",
        _ => "Very Weak"
    };
}
