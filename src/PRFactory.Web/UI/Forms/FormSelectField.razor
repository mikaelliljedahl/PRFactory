@using System.Linq.Expressions
@using PRFactory.Web.UI.Help
@typeparam TValue

<div class="mb-3">
    <label for="@FieldId" class="form-label">
        @Label
        @if (Required)
        {
            <span class="text-danger">*</span>
        }
        @if (!string.IsNullOrEmpty(HelpTooltipText))
        {
            <ContextualHelp HelpText="@HelpTooltipText"
                           Title="@HelpTooltipTitle"
                           LearnMoreUrl="@HelpTooltipLearnMoreUrl"
                           Position="@HelpTooltipPosition" />
        }
    </label>
    <select
        id="@FieldId"
        class="form-select @(IsInvalid ? "is-invalid" : "")"
        @onchange="OnValueChanged"
        disabled="@Disabled"
        required="@Required">

        @if (!string.IsNullOrEmpty(DefaultOptionText))
        {
            <option value="">@DefaultOptionText</option>
        }

        @ChildContent
    </select>

    @if (For != null)
    {
        <ValidationMessage For="@For" />
    }

    @if (!string.IsNullOrEmpty(HelpText))
    {
        <small class="form-text text-muted">@HelpText</small>
    }
</div>

@code {
    [Parameter, EditorRequired]
    public string Label { get; set; } = null!;

    [Parameter]
    public string? Id { get; set; }

    [Parameter]
    public TValue? Value { get; set; }

    [Parameter]
    public EventCallback<TValue?> ValueChanged { get; set; }

    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    [Parameter]
    public string? DefaultOptionText { get; set; }

    [Parameter]
    public bool Required { get; set; }

    [Parameter]
    public string? HelpText { get; set; }

    [Parameter]
    public bool Disabled { get; set; }

    [Parameter]
    public Expression<Func<TValue?>>? For { get; set; }

    [Parameter]
    public bool IsInvalid { get; set; }

    [Parameter]
    public string? HelpTooltipText { get; set; }

    [Parameter]
    public string? HelpTooltipTitle { get; set; }

    [Parameter]
    public string? HelpTooltipLearnMoreUrl { get; set; }

    [Parameter]
    public string HelpTooltipPosition { get; set; } = "top";

    private string FieldId => Id ?? $"field-{Label.Replace(" ", "-").ToLower()}";

    private async Task OnValueChanged(ChangeEventArgs e)
    {
        var stringValue = e.Value?.ToString();
        TValue? newValue = default;

        if (!string.IsNullOrEmpty(stringValue))
        {
            var targetType = Nullable.GetUnderlyingType(typeof(TValue)) ?? typeof(TValue);

            if (targetType.IsEnum)
            {
                newValue = (TValue)Enum.Parse(targetType, stringValue);
            }
            else
            {
                newValue = (TValue)Convert.ChangeType(stringValue, targetType);
            }
        }

        Value = newValue;
        await ValueChanged.InvokeAsync(newValue);
    }
}
