using Bunit;
using Microsoft.AspNetCore.Components;
using Microsoft.Extensions.Logging;
using Moq;
using PRFactory.Tests.Blazor;
using PRFactory.Tests.Blazor.TestDataBuilders;
using PRFactory.Web.Models;
using PRFactory.Web.Pages.Repositories;
using PRFactory.Web.Services;
using Radzen;
using Xunit;

namespace PRFactory.Tests.Pages.Repositories;

public class EditTests : PageTestBase
{
    private Mock<IRepositoryService> _mockRepositoryService;
    private Mock<NavigationManager> _mockNavigationManager;
    private Mock<ILogger<Edit>> _mockLogger;
    private Mock<DialogService> _mockDialogService;
    private Mock<IToastService> _mockToastService;

    public EditTests()
    {
        _mockRepositoryService = new Mock<IRepositoryService>();
        _mockNavigationManager = new Mock<NavigationManager>();
        _mockLogger = new Mock<ILogger<Edit>>();
        _mockDialogService = new Mock<DialogService>();
        _mockToastService = new Mock<IToastService>();

    }

    protected override void ConfigureServices(Microsoft.Extensions.DependencyInjection.IServiceCollection services)
    {
        base.ConfigureServices(services);
        services.AddSingleton(_mockRepositoryService.Object);
        services.AddSingleton(_mockNavigationManager.Object);
        services.AddSingleton(_mockLogger.Object);
        services.AddSingleton(_mockDialogService.Object);
        services.AddSingleton(_mockToastService.Object);
    }

    [Fact]
    public async Task OnInitialized_LoadsRepository()
    {
        // Arrange
        var repositoryId = Guid.NewGuid();
        var repository = new RepositoryDtoBuilder()
            .WithId(repositoryId)
            .WithName("Test Repo")
            .Build();

        _mockRepositoryService
            .Setup(x => x.GetRepositoryByIdAsync(repositoryId, It.IsAny<CancellationToken>()))
            .ReturnsAsync(repository);

        // Act
        var cut = RenderComponent<Edit>(parameters => parameters
            .Add(p => p.Id, repositoryId));

        // Assert
        await cut.InvokeAsync(() => Task.Delay(100));
        _mockRepositoryService.Verify(
            x => x.GetRepositoryByIdAsync(repositoryId, It.IsAny<CancellationToken>()),
            Times.Once);
    }

    [Fact]
    public async Task OnInitialized_WhenRepositoryNotFound_ShowsErrorMessage()
    {
        // Arrange
        var repositoryId = Guid.NewGuid();

        _mockRepositoryService
            .Setup(x => x.GetRepositoryByIdAsync(repositoryId, It.IsAny<CancellationToken>()))
            .ReturnsAsync((RepositoryDto?)null);

        // Act
        var cut = RenderComponent<Edit>(parameters => parameters
            .Add(p => p.Id, repositoryId));

        // Assert
        await cut.InvokeAsync(() => Task.Delay(100));
        cut.WaitForState(() => cut.Markup.Contains("not found") || cut.Markup.Contains("Error"));
    }

    [Fact]
    public async Task OnInitialized_WhenError_ShowsErrorMessage()
    {
        // Arrange
        var repositoryId = Guid.NewGuid();

        _mockRepositoryService
            .Setup(x => x.GetRepositoryByIdAsync(repositoryId, It.IsAny<CancellationToken>()))
            .ThrowsAsync(new Exception("Network error"));

        // Act
        var cut = RenderComponent<Edit>(parameters => parameters
            .Add(p => p.Id, repositoryId));

        // Assert
        await cut.InvokeAsync(() => Task.Delay(100));
        Assert.NotNull(cut);
    }

    [Fact]
    public async Task Render_ShowsLoadingStateInitially()
    {
        // Arrange
        var repositoryId = Guid.NewGuid();
        var tcs = new TaskCompletionSource<RepositoryDto?>();

        _mockRepositoryService
            .Setup(x => x.GetRepositoryByIdAsync(repositoryId, It.IsAny<CancellationToken>()))
            .Returns(tcs.Task);

        // Act
        var cut = RenderComponent<Edit>(parameters => parameters
            .Add(p => p.Id, repositoryId));

        // Assert
        await cut.InvokeAsync(() => Task.Delay(50));
        Assert.Contains("spinner", cut.Markup.ToLower()) || Assert.Contains("loading", cut.Markup.ToLower());

        // Complete loading
        tcs.SetResult(new RepositoryDtoBuilder().WithId(repositoryId).Build());
    }

    [Fact]
    public async Task Render_ShowsRepositoryFormWithData()
    {
        // Arrange
        var repositoryId = Guid.NewGuid();
        var repository = new RepositoryDtoBuilder()
            .WithId(repositoryId)
            .WithName("My Repository")
            .Build();

        _mockRepositoryService
            .Setup(x => x.GetRepositoryByIdAsync(repositoryId, It.IsAny<CancellationToken>()))
            .ReturnsAsync(repository);

        // Act
        var cut = RenderComponent<Edit>(parameters => parameters
            .Add(p => p.Id, repositoryId));

        // Assert
        await cut.InvokeAsync(() => Task.Delay(100));
        cut.WaitForState(() => cut.Markup.Contains("My Repository") || !cut.Markup.Contains("spinner"));
    }

    [Fact]
    public async Task UpdateRepository_WhenSuccessful_NavigatesToDetails()
    {
        // Arrange
        var repositoryId = Guid.NewGuid();
        var repository = new RepositoryDtoBuilder()
            .WithId(repositoryId)
            .Build();

        _mockRepositoryService
            .Setup(x => x.GetRepositoryByIdAsync(repositoryId, It.IsAny<CancellationToken>()))
            .ReturnsAsync(repository);

        _mockRepositoryService
            .Setup(x => x.UpdateRepositoryAsync(repositoryId, It.IsAny<UpdateRepositoryRequest>(), It.IsAny<CancellationToken>()))
            .Returns(Task.CompletedTask);

        // Act
        var cut = RenderComponent<Edit>(parameters => parameters
            .Add(p => p.Id, repositoryId));

        // Assert
        await cut.InvokeAsync(() => Task.Delay(100));
        Assert.NotNull(cut);
    }

    [Fact]
    public async Task Render_ShowsCancelButton()
    {
        // Arrange
        var repositoryId = Guid.NewGuid();
        var repository = new RepositoryDtoBuilder()
            .WithId(repositoryId)
            .Build();

        _mockRepositoryService
            .Setup(x => x.GetRepositoryByIdAsync(repositoryId, It.IsAny<CancellationToken>()))
            .ReturnsAsync(repository);

        // Act
        var cut = RenderComponent<Edit>(parameters => parameters
            .Add(p => p.Id, repositoryId));

        // Assert
        await cut.InvokeAsync(() => Task.Delay(100));
        cut.WaitForState(() => cut.Markup.Contains("Cancel") || cut.Markup.Contains("Back"));
    }
}
