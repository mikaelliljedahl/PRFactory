using Bunit;
using Microsoft.AspNetCore.Components;
using Microsoft.Extensions.Logging;
using Moq;
using PRFactory.Tests.Blazor;
using PRFactory.Tests.Blazor.TestDataBuilders;
using PRFactory.Web.Models;
using PRFactory.Web.Services;
using Radzen;
using Xunit;
using RepositoriesIndex = PRFactory.Web.Pages.Repositories.Index;

namespace PRFactory.Tests.Pages.Repositories;

public class IndexTests : PageTestBase
{
    private Mock<IRepositoryService> _mockRepositoryService;
    private Mock<NavigationManager> _mockNavigationManager;
    private Mock<ILogger<RepositoriesIndex>> _mockLogger;
    private Mock<DialogService> _mockDialogService;

    public IndexTests()
    {
        _mockRepositoryService = new Mock<IRepositoryService>();
        _mockNavigationManager = new Mock<NavigationManager>();
        _mockLogger = new Mock<ILogger<RepositoriesIndex>>();
        _mockDialogService = new Mock<DialogService>();
    }

    protected override void ConfigureServices(Microsoft.Extensions.DependencyInjection.IServiceCollection services)
    {
        base.ConfigureServices(services);
        services.AddSingleton(_mockRepositoryService.Object);
        services.AddSingleton(_mockNavigationManager.Object);
        services.AddSingleton(_mockLogger.Object);
        services.AddSingleton(_mockDialogService.Object);
    }

    [Fact]
    public async Task OnInitialized_LoadsRepositories()
    {
        // Arrange
        var repositories = new List<RepositoryDto>
        {
            new RepositoryDtoBuilder().WithName("Repo 1").Build(),
            new RepositoryDtoBuilder().WithName("Repo 2").Build()
        };

        _mockRepositoryService
            .Setup(x => x.GetAllRepositoriesAsync(It.IsAny<CancellationToken>()))
            .ReturnsAsync(repositories);

        // Act
        var cut = RenderComponent<RepositoriesIndex>();

        // Assert
        await cut.InvokeAsync(() => Task.Delay(100));
        cut.WaitForState(() => cut.Markup.Contains("Repo 1"));

        Assert.Contains("Repo 1", cut.Markup);
        Assert.Contains("Repo 2", cut.Markup);

        _mockRepositoryService.Verify(
            x => x.GetAllRepositoriesAsync(It.IsAny<CancellationToken>()),
            Times.Once);
    }

    [Fact]
    public async Task OnInitialized_WhenNoRepositories_ShowsEmptyState()
    {
        // Arrange
        _mockRepositoryService
            .Setup(x => x.GetAllRepositoriesAsync(It.IsAny<CancellationToken>()))
            .ReturnsAsync(new List<RepositoryDto>());

        // Act
        var cut = RenderComponent<RepositoriesIndex>();

        // Assert
        await cut.InvokeAsync(() => Task.Delay(100));
        cut.WaitForState(() => !cut.Markup.Contains("spinner"));
    }

    [Fact]
    public async Task OnInitialized_WhenError_ShowsErrorMessage()
    {
        // Arrange
        _mockRepositoryService
            .Setup(x => x.GetAllRepositoriesAsync(It.IsAny<CancellationToken>()))
            .ThrowsAsync(new Exception("Network error"));

        // Act
        var cut = RenderComponent<RepositoriesIndex>();

        // Assert
        await cut.InvokeAsync(() => Task.Delay(100));
        cut.WaitForState(() => cut.Markup.Contains("Failed to load repositories"));

        Assert.Contains("Failed to load repositories", cut.Markup);
    }

    [Fact]
    public async Task Render_ShowsLoadingStateInitially()
    {
        // Arrange
        var tcs = new TaskCompletionSource<List<RepositoryDto>>();
        _mockRepositoryService
            .Setup(x => x.GetAllRepositoriesAsync(It.IsAny<CancellationToken>()))
            .Returns(tcs.Task);

        // Act
        var cut = RenderComponent<RepositoriesIndex>();

        // Assert
        await cut.InvokeAsync(() => Task.Delay(50));
        Assert.Contains("spinner", cut.Markup.ToLower());

        // Complete loading
        tcs.SetResult(new List<RepositoryDto>());
    }

    [Fact]
    public async Task Render_ShowsRepositoryCount()
    {
        // Arrange
        var repositories = new List<RepositoryDto>
        {
            new RepositoryDtoBuilder().Build(),
            new RepositoryDtoBuilder().Build(),
            new RepositoryDtoBuilder().Build()
        };

        _mockRepositoryService
            .Setup(x => x.GetAllRepositoriesAsync(It.IsAny<CancellationToken>()))
            .ReturnsAsync(repositories);

        // Act
        var cut = RenderComponent<RepositoriesIndex>();

        // Assert
        await cut.InvokeAsync(() => Task.Delay(100));
        cut.WaitForState(() => cut.Markup.Contains("3"));
    }

    [Fact]
    public async Task Render_ShowsCreateRepositoryButton()
    {
        // Arrange
        _mockRepositoryService
            .Setup(x => x.GetAllRepositoriesAsync(It.IsAny<CancellationToken>()))
            .ReturnsAsync(new List<RepositoryDto>());

        // Act
        var cut = RenderComponent<RepositoriesIndex>();

        // Assert
        await cut.InvokeAsync(() => Task.Delay(100));
        cut.WaitForState(() => cut.Markup.Contains("Create Repository") ||
                              cut.Markup.Contains("Add Repository") ||
                              cut.Markup.Contains("New Repository"));
    }

    [Fact]
    public async Task Render_ShowsRepositoriesWithMultiplePlatforms()
    {
        // Arrange
        var repositories = new List<RepositoryDto>
        {
            RepositoryDtoBuilder.GitHub().WithName("GitHub Repo").Build(),
            RepositoryDtoBuilder.Bitbucket().WithName("Bitbucket Repo").Build(),
            RepositoryDtoBuilder.AzureDevOps().WithName("Azure Repo").Build()
        };

        _mockRepositoryService
            .Setup(x => x.GetAllRepositoriesAsync(It.IsAny<CancellationToken>()))
            .ReturnsAsync(repositories);

        // Act
        var cut = RenderComponent<RepositoriesIndex>();

        // Assert
        await cut.InvokeAsync(() => Task.Delay(100));
        cut.WaitForState(() => cut.Markup.Contains("GitHub Repo"));

        Assert.Contains("GitHub", cut.Markup);
        Assert.Contains("Bitbucket", cut.Markup);
        Assert.Contains("AzureDevOps", cut.Markup);
    }

    [Fact]
    public async Task Render_ShowsBreadcrumbs()
    {
        // Arrange
        _mockRepositoryService
            .Setup(x => x.GetAllRepositoriesAsync(It.IsAny<CancellationToken>()))
            .ReturnsAsync(new List<RepositoryDto>());

        // Act
        var cut = RenderComponent<RepositoriesIndex>();

        // Assert
        await cut.InvokeAsync(() => Task.Delay(100));
        Assert.Contains("Dashboard", cut.Markup) || Assert.Contains("Repositories", cut.Markup);
    }
}
