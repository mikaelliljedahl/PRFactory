using Bunit;
using Moq;
using PRFactory.Tests.Blazor;
using PRFactory.Tests.Blazor.TestDataBuilders;
using PRFactory.Web.Pages.Tickets;
using Xunit;
using static Moq.It;
using static Moq.Times;

namespace PRFactory.Tests.Pages.Tickets;

public class DetailTests : PageTestBase
{
    [Fact]
    public async Task OnInitialized_LoadsTicketDetailsQuestionsAndEvents()
    {
        // Arrange
        var ticketId = Guid.NewGuid();
        var ticket = new TicketDtoBuilder()
            .WithId(ticketId)
            .WithTicketKey("TEST-123")
            .Build();

        var questions = new List<PRFactory.Web.Models.QuestionDto>();
        var events = new List<PRFactory.Web.Models.WorkflowEventDto>();

        BlazorMockHelpers.SetupGetTicketDtoById(MockTicketService, ticketId, ticket);
        BlazorMockHelpers.SetupGetQuestions(MockTicketService, ticketId, questions);
        BlazorMockHelpers.SetupGetEvents(MockTicketService, ticketId, events);

        // Act
        var cut = RenderComponent<Detail>(parameters => parameters
            .Add(p => p.Id, ticketId.ToString()));

        cut.WaitForState(() => cut.Markup.Contains("TEST-123"), timeout: TimeSpan.FromSeconds(5));

        // Assert
        Assert.Contains("TEST-123", cut.Markup);
        MockTicketService.Verify(x => x.GetTicketDtoByIdAsync(ticketId, It.IsAny<CancellationToken>()), Times.Once);
        MockTicketService.Verify(x => x.GetQuestionsAsync(ticketId, It.IsAny<CancellationToken>()), Times.Once);
        MockTicketService.Verify(x => x.GetEventsAsync(ticketId, It.IsAny<CancellationToken>()), Times.Once);
    }

    [Fact]
    public async Task OnInitialized_WithInvalidId_ShowsError()
    {
        // Act
        var cut = RenderComponent<Detail>(parameters => parameters
            .Add(p => p.Id, "invalid-guid"));

        cut.WaitForState(() => cut.Markup.Contains("Invalid") || cut.Markup.Contains("error"), timeout: TimeSpan.FromSeconds(5));

        // Assert
        Assert.Contains("Invalid", cut.Markup);
    }

    [Fact]
    public async Task OnInitialized_HandlesServiceError()
    {
        // Arrange
        var ticketId = Guid.NewGuid();
        MockTicketService.Setup(m => m.GetTicketDtoByIdAsync(ticketId, It.IsAny<CancellationToken>()))
            .ThrowsAsync(new Exception("Failed to load ticket"));

        // Act
        var cut = RenderComponent<Detail>(parameters => parameters
            .Add(p => p.Id, ticketId.ToString()));

        cut.WaitForState(() => cut.Markup.Contains("Error") || cut.Markup.Contains("Failed"), timeout: TimeSpan.FromSeconds(5));

        // Assert
        BlazorMockHelpers.VerifyErrorToast(MockToastService);
    }

    [Fact]
    public async Task Renders_TicketHeader()
    {
        // Arrange
        var ticketId = Guid.NewGuid();
        var ticket = new TicketDtoBuilder()
            .WithId(ticketId)
            .WithTicketKey("TEST-123")
            .WithTitle("Test Ticket Title")
            .Build();

        BlazorMockHelpers.SetupGetTicketDtoById(MockTicketService, ticketId, ticket);
        BlazorMockHelpers.SetupGetQuestions(MockTicketService, ticketId, new List<PRFactory.Web.Models.QuestionDto>());
        BlazorMockHelpers.SetupGetEvents(MockTicketService, ticketId, new List<PRFactory.Web.Models.WorkflowEventDto>());

        // Act
        var cut = RenderComponent<Detail>(parameters => parameters
            .Add(p => p.Id, ticketId.ToString()));

        cut.WaitForState(() => cut.Markup.Contains("TEST-123"), timeout: TimeSpan.FromSeconds(5));

        // Assert
        Assert.Contains("TEST-123", cut.Markup);
        Assert.Contains("Test Ticket Title", cut.Markup);
    }

    [Fact]
    public async Task Renders_QuestionAnswerForm_WhenQuestionsExist()
    {
        // Arrange
        var ticketId = Guid.NewGuid();
        var ticket = new TicketDtoBuilder()
            .WithId(ticketId)
            .WithState(Domain.ValueObjects.WorkflowState.AwaitingAnswers)
            .Build();

        var questions = new List<PRFactory.Web.Models.QuestionDto>
        {
            new QuestionDtoBuilder().WithText("Test Question").Build()
        };

        BlazorMockHelpers.SetupGetTicketDtoById(MockTicketService, ticketId, ticket);
        BlazorMockHelpers.SetupGetQuestions(MockTicketService, ticketId, questions);
        BlazorMockHelpers.SetupGetEvents(MockTicketService, ticketId, new List<PRFactory.Web.Models.WorkflowEventDto>());

        // Act
        var cut = RenderComponent<Detail>(parameters => parameters
            .Add(p => p.Id, ticketId.ToString()));

        cut.WaitForState(() => cut.Markup.Contains("Test Question"), timeout: TimeSpan.FromSeconds(5));

        // Assert
        Assert.Contains("Test Question", cut.Markup);
    }

    [Fact]
    public async Task Renders_TicketUpdatePreview_WhenInReviewState()
    {
        // Arrange
        var ticketId = Guid.NewGuid();
        var ticket = new TicketDtoBuilder()
            .WithId(ticketId)
            .WithState(Domain.ValueObjects.WorkflowState.TicketUpdateUnderReview)
            .Build();

        var ticketUpdate = new TicketUpdateDtoBuilder()
            .WithTicketId(ticketId)
            .Build();

        BlazorMockHelpers.SetupGetTicketDtoById(MockTicketService, ticketId, ticket);
        BlazorMockHelpers.SetupGetQuestions(MockTicketService, ticketId, new List<PRFactory.Web.Models.QuestionDto>());
        BlazorMockHelpers.SetupGetEvents(MockTicketService, ticketId, new List<PRFactory.Web.Models.WorkflowEventDto>());
        BlazorMockHelpers.SetupGetLatestUpdate(MockTicketService, ticketId, ticketUpdate);

        // Act
        var cut = RenderComponent<Detail>(parameters => parameters
            .Add(p => p.Id, ticketId.ToString()));

        cut.WaitForState(() => !cut.Markup.Contains("Loading"), timeout: TimeSpan.FromSeconds(5));

        // Assert - TicketUpdatePreview component should be rendered
        Assert.NotNull(cut.Markup);
    }

    [Fact]
    public async Task Renders_PlanReviewSection_WhenPlanUnderReview()
    {
        // Arrange
        var ticketId = Guid.NewGuid();
        var ticket = new TicketDtoBuilder()
            .WithId(ticketId)
            .WithState(Domain.ValueObjects.WorkflowState.PlanUnderReview)
            .Build();

        BlazorMockHelpers.SetupGetTicketDtoById(MockTicketService, ticketId, ticket);
        BlazorMockHelpers.SetupGetQuestions(MockTicketService, ticketId, new List<PRFactory.Web.Models.QuestionDto>());
        BlazorMockHelpers.SetupGetEvents(MockTicketService, ticketId, new List<PRFactory.Web.Models.WorkflowEventDto>());
        BlazorMockHelpers.SetupGetReviewers(MockTicketService, ticketId, new List<PRFactory.Web.Models.ReviewerDto>());
        BlazorMockHelpers.SetupGetComments(MockTicketService, ticketId, new List<PRFactory.Web.Models.ReviewCommentDto>());

        // Act
        var cut = RenderComponent<Detail>(parameters => parameters
            .Add(p => p.Id, ticketId.ToString()));

        cut.WaitForState(() => !cut.Markup.Contains("Loading"), timeout: TimeSpan.FromSeconds(5));

        // Assert - PlanReviewSection component should be rendered
        Assert.NotNull(cut.Markup);
    }

    [Fact]
    public async Task Renders_WorkflowTimeline()
    {
        // Arrange
        var ticketId = Guid.NewGuid();
        var ticket = new TicketDtoBuilder()
            .WithId(ticketId)
            .Build();

        var events = new List<PRFactory.Web.Models.WorkflowEventDto>
        {
            WorkflowEventDtoBuilder.StateChanged(
                Domain.ValueObjects.WorkflowState.Triggered,
                Domain.ValueObjects.WorkflowState.Analyzing).Build()
        };

        BlazorMockHelpers.SetupGetTicketDtoById(MockTicketService, ticketId, ticket);
        BlazorMockHelpers.SetupGetQuestions(MockTicketService, ticketId, new List<PRFactory.Web.Models.QuestionDto>());
        BlazorMockHelpers.SetupGetEvents(MockTicketService, ticketId, events);

        // Act
        var cut = RenderComponent<Detail>(parameters => parameters
            .Add(p => p.Id, ticketId.ToString()));

        cut.WaitForState(() => !cut.Markup.Contains("Loading"), timeout: TimeSpan.FromSeconds(5));

        // Assert - WorkflowTimeline should be rendered with events
        Assert.NotNull(cut.Markup);
    }

    [Fact]
    public async Task HandleAnswersSubmitted_ReloadsTicketAndEvents()
    {
        // Arrange
        var ticketId = Guid.NewGuid();
        var ticket = new TicketDtoBuilder()
            .WithId(ticketId)
            .WithState(Domain.ValueObjects.WorkflowState.AwaitingAnswers)
            .Build();

        var questions = new List<PRFactory.Web.Models.QuestionDto>
        {
            new QuestionDtoBuilder().WithText("Question 1").Build()
        };

        var callCount = 0;
        MockTicketService.Setup(m => m.GetTicketDtoByIdAsync(ticketId, It.IsAny<CancellationToken>()))
            .ReturnsAsync(() =>
            {
                callCount++;
                return ticket;
            });

        BlazorMockHelpers.SetupGetQuestions(MockTicketService, ticketId, questions);
        BlazorMockHelpers.SetupGetEvents(MockTicketService, ticketId, new List<PRFactory.Web.Models.WorkflowEventDto>());

        // Act
        var cut = RenderComponent<Detail>(parameters => parameters
            .Add(p => p.Id, ticketId.ToString()));

        cut.WaitForState(() => cut.Markup.Contains("Question 1"), timeout: TimeSpan.FromSeconds(5));

        // Assert - GetTicketDtoByIdAsync should be called at least once
        Assert.True(callCount >= 1);
    }

    [Fact]
    public async Task Renders_Breadcrumbs()
    {
        // Arrange
        var ticketId = Guid.NewGuid();
        var ticket = new TicketDtoBuilder()
            .WithId(ticketId)
            .WithTicketKey("TEST-123")
            .Build();

        BlazorMockHelpers.SetupGetTicketDtoById(MockTicketService, ticketId, ticket);
        BlazorMockHelpers.SetupGetQuestions(MockTicketService, ticketId, new List<PRFactory.Web.Models.QuestionDto>());
        BlazorMockHelpers.SetupGetEvents(MockTicketService, ticketId, new List<PRFactory.Web.Models.WorkflowEventDto>());

        // Act
        var cut = RenderComponent<Detail>(parameters => parameters
            .Add(p => p.Id, ticketId.ToString()));

        cut.WaitForState(() => cut.Markup.Contains("TEST-123"), timeout: TimeSpan.FromSeconds(5));

        // Assert - Should render breadcrumbs
        Assert.Contains("Dashboard", cut.Markup);
        Assert.Contains("Tickets", cut.Markup);
        Assert.Contains("TEST-123", cut.Markup);
    }

    [Fact]
    public async Task LoadQuestions_HandlesServiceError_Gracefully()
    {
        // Arrange
        var ticketId = Guid.NewGuid();
        var ticket = new TicketDtoBuilder()
            .WithId(ticketId)
            .Build();

        BlazorMockHelpers.SetupGetTicketDtoById(MockTicketService, ticketId, ticket);
        MockTicketService.Setup(m => m.GetQuestionsAsync(ticketId, It.IsAny<CancellationToken>()))
            .ThrowsAsync(new Exception("Failed to load questions"));
        BlazorMockHelpers.SetupGetEvents(MockTicketService, ticketId, new List<PRFactory.Web.Models.WorkflowEventDto>());

        // Act
        var cut = RenderComponent<Detail>(parameters => parameters
            .Add(p => p.Id, ticketId.ToString()));

        await Task.Delay(500);

        // Assert - Page should still load (questions error is non-critical)
        Assert.NotNull(cut.Markup);
    }

    [Fact]
    public async Task LoadEvents_HandlesServiceError_Gracefully()
    {
        // Arrange
        var ticketId = Guid.NewGuid();
        var ticket = new TicketDtoBuilder()
            .WithId(ticketId)
            .Build();

        BlazorMockHelpers.SetupGetTicketDtoById(MockTicketService, ticketId, ticket);
        BlazorMockHelpers.SetupGetQuestions(MockTicketService, ticketId, new List<PRFactory.Web.Models.QuestionDto>());
        MockTicketService.Setup(m => m.GetEventsAsync(ticketId, It.IsAny<CancellationToken>()))
            .ThrowsAsync(new Exception("Failed to load events"));

        // Act
        var cut = RenderComponent<Detail>(parameters => parameters
            .Add(p => p.Id, ticketId.ToString()));

        await Task.Delay(500);

        // Assert - Page should still load (events error is non-critical)
        Assert.NotNull(cut.Markup);
    }
}
